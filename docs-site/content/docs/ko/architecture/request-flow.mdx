---
title: 요청 흐름
description: Bingsan의 HTTP 요청 처리 방식
---

# 요청 흐름

Bingsan이 요청을 처리하는 방식을 이해하면 디버깅과 성능 최적화에 도움이 됩니다.

## HTTP 요청 라이프사이클

```
┌──────────────┐
│   클라이언트  │
└──────┬───────┘
       │ HTTP 요청
       ▼
┌──────────────────────────────────────────────┐
│              Fiber HTTP 서버                 │
├──────────────────────────────────────────────┤
│  1. Request ID 미들웨어                      │
│  2. Recovery 미들웨어 (패닉 처리)            │
│  3. Prometheus 메트릭 미들웨어               │
│  4. CORS 미들웨어                            │
│  5. 로거 미들웨어                            │
│  6. 인증 미들웨어 (활성화 시)                │
├──────────────────────────────────────────────┤
│              라우트 핸들러                    │
├──────────────────────────────────────────────┤
│           데이터베이스 작업                   │
├──────────────────────────────────────────────┤
│           이벤트 발행                         │
└──────────────────────────────────────────────┘
       │
       ▼ HTTP 응답
┌──────────────┐
│   클라이언트  │
└──────────────┘
```

## 미들웨어 스택

### 1. Request ID

각 요청에 고유 ID를 할당하여 추적합니다. `X-Request-ID` 헤더로 반환됩니다.

### 2. Recovery

패닉을 잡아 500 Internal Server Error를 반환합니다.

### 3. Prometheus 메트릭

요청 메트릭을 기록합니다:
- `iceberg_catalog_http_requests_total` - 카운터
- `iceberg_catalog_http_request_duration_seconds` - 히스토그램

### 4. CORS

설정 가능한 오리진과 메서드로 크로스 오리진 요청을 허용합니다.

### 5. 로거

메서드, 경로, 상태, 지연시간, 요청 ID 등 요청 상세 정보를 로깅합니다.

### 6. 인증

활성화 시 Bearer 토큰을 검증합니다. 토큰이 유효하지 않거나 없으면 401을 반환합니다.

## 테이블 커밋 흐름

가장 복잡한 작업은 테이블 커밋입니다:

```
┌──────────────┐
│   클라이언트  │
└──────┬───────┘
       │ POST /v1/namespaces/{ns}/tables/{table}
       ▼
┌──────────────────────────────────────────────┐
│           CommitTable 핸들러                  │
├──────────────────────────────────────────────┤
│  1. 요청 본문 파싱                            │
│  2. 테이블 식별자 검증                        │
│  3. 테이블 락 획득 (PostgreSQL advisory)     │
│  4. 트랜잭션 시작                            │
│  5. 현재 메타데이터 로드                      │
│  6. 요구사항 확인                            │
│  7. 업데이트 적용                            │
│  8. 새 메타데이터 파일 쓰기 (S3/GCS)         │
│  9. 데이터베이스 업데이트                     │
│ 10. 트랜잭션 커밋                            │
│ 11. 락 해제                                  │
│ 12. 이벤트 발행                              │
└──────────────────────────────────────────────┘
```

## 에러 처리

### 클라이언트 에러 (4xx)

- **400 Bad Request**: 유효하지 않은 JSON, 필수 필드 누락
- **401 Unauthorized**: 토큰 누락 또는 유효하지 않음
- **404 Not Found**: 네임스페이스/테이블 존재하지 않음
- **409 Conflict**: 요구사항 확인 실패

### 서버 에러 (5xx)

- **500 Internal Server Error**: 예기치 않은 에러, 데이터베이스 장애
- **503 Service Unavailable**: 데이터베이스 불가용

## 성능 고려사항

### 커넥션 풀링

pgx/v5를 통해 데이터베이스 연결이 풀링되며 최대/최소 연결 수 설정 가능합니다.

### 요청당 고루틴

각 요청은 자체 고루틴에서 실행되며 자동 스케줄링과 효율적인 메모리 사용이 이루어집니다.

### JSON 직렬화

더 빠른 JSON 인코딩/디코딩을 위해 [goccy/go-json](https://github.com/goccy/go-json)을 사용합니다.

---
title: 튜닝
description: Bingsan 성능 튜닝 가이드라인
---

# 성능 튜닝

이 가이드는 워크로드 특성에 따른 최적의 성능을 위해 Bingsan을 튜닝하는 방법을 다룹니다.

## 빠른 참조

| 워크로드 | 잠금 타임아웃 | 재시도 간격 | 최대 재시도 | 버퍼 크기 |
|----------|--------------|------------|-------------|----------|
| 저지연 | 5s | 50ms | 20 | 4KB |
| 고처리량 | 30s | 100ms | 100 | 4KB |
| 대형 스키마 | 30s | 100ms | 100 | 8-16KB |
| 배치 처리 | 120s | 1s | 60 | 4KB |

## 워크로드 프로파일

### 저지연

처리량보다 빠른 응답 우선:

```yaml
catalog:
  lock_timeout: 5s
  lock_retry_interval: 50ms
  max_lock_retries: 20

server:
  read_timeout: 10s
  write_timeout: 10s

database:
  max_open_conns: 50
  max_idle_conns: 25
```

### 고처리량

초당 요청 최대화:

```yaml
catalog:
  lock_timeout: 30s
  lock_retry_interval: 100ms
  max_lock_retries: 100

server:
  read_timeout: 60s
  write_timeout: 60s
  idle_timeout: 300s

database:
  max_open_conns: 100
  max_idle_conns: 50
  conn_max_lifetime: 30m
```

### 배치 처리

대량 작업용:

```yaml
catalog:
  lock_timeout: 120s
  lock_retry_interval: 1s
  max_lock_retries: 60

server:
  read_timeout: 300s
  write_timeout: 300s

database:
  max_open_conns: 25
  conn_max_lifetime: 60m
```

## 증상별 튜닝

### 높은 지연시간

**진단:**
```text
# 잠금 대기 시간 확인
rate(iceberg_db_wait_duration_seconds_total[5m])

# 풀 폐기율 확인
rate(bingsan_pool_discards_total[5m])

# 커넥션 포화 확인
iceberg_db_connections_in_use / iceberg_db_connections_max
```

**해결책:**
1. 잠금 경합 - `lock_timeout` 줄이기, `max_lock_retries` 늘리기
2. 풀 폐기 - 대형 스키마용 `MaxBufferSize` 늘리기
3. 커넥션 풀 - `max_open_conns` 늘리기

### 높은 메모리 사용량

**진단:**
```bash
curl http://localhost:8181/debug/pprof/heap > heap.prof
go tool pprof heap.prof
```

**해결책:**
1. 버퍼 누수 - 모든 코드 경로가 버퍼를 반환하는지 확인
2. 큰 버퍼 - `MaxBufferSize` 줄이기
3. 커넥션 비대 - `max_open_conns` 줄이기

### 잠금 타임아웃 에러

**진단:**
```sql
SELECT * FROM pg_locks WHERE NOT granted;
SELECT * FROM pg_stat_activity WHERE wait_event_type = 'Lock';
```

**해결책:**
1. 높은 경합 - `max_lock_retries` 늘리기
2. 느린 트랜잭션 - 트랜잭션 짧게 유지
3. 데드락 - Bingsan이 자동으로 처리

## 데이터베이스 튜닝

### PostgreSQL 설정

```sql
ALTER SYSTEM SET max_connections = 500;
ALTER SYSTEM SET lock_timeout = '30s';
ALTER SYSTEM SET statement_timeout = '60s';
ALTER SYSTEM SET effective_cache_size = '12GB';
ALTER SYSTEM SET shared_buffers = '4GB';
```

### PgBouncer를 통한 커넥션 풀링

```ini
[databases]
iceberg_catalog = host=postgres port=5432 dbname=iceberg_catalog

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 50
```

## 리소스 크기

### 메모리

```
memory_per_instance = base + (concurrent_requests × request_memory)
                   ≈ 50MB + (500 × 100KB)
                   ≈ 100MB 일반
                   ≈ 200MB 피크
```

### CPU

```
cpu_per_instance ≈ 0.2 코어 유휴
                 ≈ 1 코어 부하 시
```

### 인스턴스

```
instances = (peak_rps / rps_per_instance) × 1.5
```

## 프로파일링

### CPU 프로파일

```bash
curl http://localhost:8181/debug/pprof/profile?seconds=30 > cpu.prof
go tool pprof -http=:8080 cpu.prof
```

### 메모리 프로파일

```bash
curl http://localhost:8181/debug/pprof/heap > heap.prof
go tool pprof -http=:8080 heap.prof
```

### 추적

```bash
curl http://localhost:8181/debug/pprof/trace?seconds=5 > trace.out
go tool trace trace.out
```

## 체크리스트

### 프로덕션 전

- [ ] 워크로드에 적합한 `lock_timeout` 설정
- [ ] 예상 부하에 따른 `max_open_conns` 구성
- [ ] Prometheus 메트릭 수집 활성화
- [ ] 풀 상태 알림 설정
- [ ] 현실적인 데이터로 부하 테스트 실행

### 프로덕션 모니터링

- [ ] 풀 히트율 > 80%
- [ ] 풀 폐기율 < 1%
- [ ] 잠금 타임아웃율 < 1%
- [ ] 커넥션 활용률 < 90%
- [ ] GC 일시정지 p99 < 10ms
